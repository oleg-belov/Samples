<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF8">
<style>
p.c    { }
h1     { font-size: 160%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
div.s1 { margin-left: 20px; padding-left: 10px; font-weight: bold; }
div.s2 { margin-left: 80px; padding-left: 10px; font-weight: bold; }
div.s3 { margin-left: 140px; padding-left: 10px; font-weight: bold; }
div.r1 { margin-left: 20px; padding-left: 10px; }
div.r2 { margin-left: 80px; padding-left: 10px; }
div.r3 { margin-left: 140px; padding-left: 10px; }
div.e  { margin-left: 20px; padding-left: 10px; font-weight: bold; <!--color: darkblue;--> }
div.r  { margin-left: 20px; padding-left: 10px; <!--color: darkblue;--> }
</style>
</head>
<body>
<h1>
Обзор базового инструментария
</h1>
<p class="C">
Управление файлами:
</p>
<ul class="U">
<li>командная строка: ls, pwd, cd...</li>
<li>графические менеджеры: mc, Thunar(встроенный файловый менеджер)</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Редакторы файлов:
</p>
<ul class="U">
<li>vim - текстовый редактор</li>
<li>nano - текстовый редактор</li>
<li>gedit - графический редактор</li>
<li>mousepad - графический редактор</li>
<li>mc - управление файлами с встроенным редактором</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
СУБД PostgreSQL
</h1>
<p class="C">
Установка выполнена из пакета. Каталог установки PostgreSQL:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">root$ <span style="color:#00a150">ls</span> <span style="color:#323232">-</span>l <span style="color:#323232">/</span>usr<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span>
</pre>
</div>
<div class="R"><pre class="R">
total 8
drwxr-xr-x 2 root root 4096 дек 26  2016 bin
drwxr-xr-x 2 root root 4096 дек 26  2016 lib
</pre></div>
<p class="C">
Владелец ПО сервера - пользователь root.
</p>
<p class="C">
В Ubuntu доступ к утилитам сервера выполняется через обертки.  Например,
для управления сервером вместо pg_ctl используется pg_ctlcluster.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
При установке из пакета также инициализируется кластер баз данных, а в
настройки запуска ОС добавляется запуск PostgreSQL. Поэтому после загрузки
операционной системы, отдельно стартовать PostgreSQL не нужно.  Если требуется
явным образом остановить или запустить сервер, то это делается командами:
</p>
<ul class="U">
<li>Остановить сервер: pg_ctlcluster 9.6 main stop</li>
<li>Запустить сервер : pg_ctlcluster 9.6 main start</li>
<li>Перезапустить    : pg_ctlcluster 9.6 main restart</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Кластер баз данных установлен в каталог: /var/lib/postgresql/9.6/main
</p>
<p class="C">
Владельцем каталога является пользователь postgres.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Вот содержимое этого каталога:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">ls</span> <span style="color:#323232">-</span>l <span style="color:#323232">/</span>var<span style="color:#323232">/</span>lib<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span><span style="color:#323232">/</span>main
</pre>
</div>
<div class="R"><pre class="R">
total 88
drwx------ 28 postgres postgres 4096 июл 22 23:38 base
drwx------  2 postgres postgres 4096 июл 22 23:38 global
drwx------  2 postgres postgres 4096 дек 26  2016 pg_clog
drwx------  2 postgres postgres 4096 дек 26  2016 pg_commit_ts
drwx------  2 postgres postgres 4096 дек 26  2016 pg_dynshmem
drwxr-xr-x  2 postgres root     4096 июл 22 23:27 pg_log
drwx------  4 postgres postgres 4096 дек 26  2016 pg_logical
drwx------  4 postgres postgres 4096 дек 26  2016 pg_multixact
drwx------  2 postgres postgres 4096 июл 22 23:29 pg_notify
drwx------  2 postgres postgres 4096 дек 26  2016 pg_replslot
drwx------  2 postgres postgres 4096 дек 26  2016 pg_serial
drwx------  2 postgres postgres 4096 дек 26  2016 pg_snapshots
drwx------  2 postgres postgres 4096 июл 22 23:29 pg_stat
drwx------  2 postgres postgres 4096 янв 10  2017 pg_stat_tmp
drwx------  2 postgres postgres 4096 дек 26  2016 pg_subtrans
drwx------  2 postgres postgres 4096 июл 22 23:27 pg_tblspc
drwx------  2 postgres postgres 4096 дек 26  2016 pg_twophase
-rw-------  1 postgres postgres    4 дек 26  2016 PG_VERSION
drwx------  3 postgres postgres 4096 июл 22 23:28 pg_xlog
-rw-------  1 postgres postgres  107 июл 22 23:29 postgresql.auto.conf
-rw-------  1 postgres postgres  133 июл 22 23:29 postmaster.opts
-rw-------  1 postgres postgres   92 июл 22 23:29 postmaster.pid
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Основной файл конфигурации postgresql.conf расположен в:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">ls</span> <span style="color:#323232">-</span>l <span style="color:#323232">/</span>etc<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span><span style="color:#323232">/</span>main
</pre>
</div>
<div class="R"><pre class="R">
total 48
-rw-r--r-- 1 postgres postgres   315 дек 26  2016 environment
-rw-r--r-- 1 postgres postgres   143 дек 26  2016 pg_ctl.conf
-rw-r----- 1 postgres postgres  4641 июл 22 23:29 pg_hba.conf
-rw-r----- 1 postgres postgres  1636 дек 26  2016 pg_ident.conf
-rw-r--r-- 1 postgres postgres 22465 июл 22 23:38 postgresql.conf
-rw-r--r-- 1 postgres postgres   317 дек 26  2016 start.conf
</pre></div>
<p class="C">
Здесь же находятся и другие конфигурационные файлы.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Журнал сервера находится здесь:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">ls</span> <span style="color:#323232">-</span>l <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log
</pre>
</div>
<div class="R"><pre class="R">
-rw-r----- 1 postgres adm 7471 июл 22 23:29 /var/log/postgresql/postgresql-9.6-main.log
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Заглянем в конец журнала:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">10</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log
</pre>
</div>
<div class="R"><pre class="R">
2017-07-22 23:29:03 MSK [1825-1] LOG:  autovacuum launcher started
2017-07-22 23:29:03 MSK [1827-1] [unknown]@[unknown] LOG:  incomplete startup packet
2017-07-22 23:29:05 MSK [1976-1] r@access_overview ERROR:  permission denied for relation t
2017-07-22 23:29:05 MSK [1976-2] r@access_overview STATEMENT:  UPDATE s.t SET key = key+1 WHERE key = 2;
2017-07-22 23:29:11 MSK [2057-1] student@student ERROR:  database "access_overview" is being accessed by other users
2017-07-22 23:29:11 MSK [2057-2] student@student DETAIL:  There are 2 other sessions using the database.
2017-07-22 23:29:11 MSK [2057-3] student@student STATEMENT:  DROP DATABASE access_overview;
2017-07-22 23:29:11 MSK [2057-4] student@student ERROR:  role "r" cannot be dropped because some objects depend on it
2017-07-22 23:29:11 MSK [2057-5] student@student DETAIL:  3 objects in database access_overview
2017-07-22 23:29:11 MSK [2057-6] student@student STATEMENT:  DROP ROLE r;
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Параметры конфигурации
</h1>
<p class="C">
Проверим значение параметра work_mem:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SHOW</span> work_mem<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 work_mem 
----------
 4MB
(1 row)

</pre></div>
<p class="C">
Параметр work_mem задает объем памяти, который будет использоваться для
внутренних операций сортировки и хеш-таблиц, прежде чем будут задействованы
временные файлы на диске.
</p>
<p class="C">
4MB - это значение по умолчанию и оно слишком мало. Допустим мы хотим увеличить
его для всех до 16MB. Для этого можно внести изменения в postgresql.conf и
обновить конфигурацию.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Редактируем postgresql.conf любым текстовым редактором. Для целей демонстрации
воспользуемся утилитами командной строки.  Файл принадлежит пользователю
postgres, поэтому вносим правки именно этим пользователем.
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">sed</span> <span style="color:#1094a0">'/^work_mem/d'</span> <span style="color:#323232">-</span>i <span style="color:#323232">/</span>etc<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span><span style="color:#323232">/</span>main<span style="color:#323232">/</span>postgresql.conf
</pre>
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#a00050">echo</span> <span style="color:#1094a0">'work_mem = 16MB'</span> <span style="color:#323232">&gt;&gt; /</span>etc<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span><span style="color:#323232">/</span>main<span style="color:#323232">/</span>postgresql.conf
</pre>
</div>
<p class="C">
Заглянем в конец файла:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">postgres$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">5</span> <span style="color:#323232">/</span>etc<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span><span style="color:#1094a0">9.6</span><span style="color:#323232">/</span>main<span style="color:#323232">/</span>postgresql.conf
</pre>
</div>
<div class="R"><pre class="R">
# CUSTOMIZED OPTIONS
#------------------------------------------------------------------------------

# Add settings for extensions here
work_mem = 16MB
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Теперь нужно обновить конфигурацию. Воспользуемся pg_ctlcluster.  Эту утилиту
также нужно запускать из под postgres или через sudo:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">$ sudo <span style="color:#00a150">pg_ctlcluster</span> <span style="color:#1094a0">9.6</span> main reload
</pre>
</div>
<p class="C">
Указание reload заставляет PostgreSQL перечитать файлы конфигурации.
Это происходит без перезагрузки сервера.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Еще раз проверим значение параметра work_mem:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SHOW</span> work_mem<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 work_mem 
----------
 16MB
(1 row)

</pre></div>
<p class="C">
Изменения вступили в силу.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Большинству параметров можно установить новое значение для текущего сеанса во
время выполнения. Например, если мы собираемся выполнить запрос, сортирующий
большой объем данных, то для сеанса можно увеличить значение work_mem:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> work_mem <span style="color:#323232">=</span> <span style="color:#1094a0">'64MB'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SHOW</span> work_mem<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 work_mem 
----------
 64MB
(1 row)

</pre></div>
<p class="C">
Новое значенние действует только в текущем сеансе или в текущей транзакции
(SET LOCAL).
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Работа в psql
</h1>
<p class="C">
Проверим текущее подключение:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\conninfo</span>
</pre>
</div>
<div class="R1"><pre class="R1">
You are connected to database "tools_overview" as user "student" via socket in "/var/run/postgresql" at port "5432".
</pre></div>
<p class="C">
Команда \c[onnect] выполняет новое подключение, не покидая psql.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
psql умеет выводить результат запросов в разных форматах:
</p>
<ul class="U">
<li>формат с выравниванием значений;</li>
<li>формат без выравнивания;</li>
<li>расширенный формат.</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Формат с выравниванием используется по умолчанию:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> name<span style="color:#323232">,</span> setting<span style="color:#323232">,</span> unit <span style="color:#3b6ac8">from</span> pg_settings <span style="color:#3b6ac8">limit</span> <span style="color:#1094a0">7</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
          name           |  setting   | unit 
-------------------------+------------+------
 allow_system_table_mods | off        | 
 application_name        | psql       | 
 archive_command         | (disabled) | 
 archive_mode            | off        | 
 archive_timeout         | 0          | s
 array_nulls             | on         | 
 authentication_timeout  | 60         | s
(7 rows)

</pre></div>
<p class="C">
Ширина столбцов выровнена по значениям.
</p>
<p class="C">
Также выводится строка заголовков и итоговая строка.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Команды psql для переключения режима выравнивания:
</p>
<ul class="U">
<li>\a - переключатель режима: с выравниванием/без выравнивания.</li>
<li>\t - переключатель отображения строки заголовка и итоговой строки.</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Отключим выравнивание, заголовок и итоговую строку:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\a</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Output format is unaligned.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\t</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Tuples only is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> name<span style="color:#323232">,</span> setting<span style="color:#323232">,</span> unit <span style="color:#3b6ac8">from</span> pg_settings <span style="color:#3b6ac8">limit</span> <span style="color:#1094a0">7</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
allow_system_table_mods|off|
application_name|psql|
archive_command|(disabled)|
archive_mode|off|
archive_timeout|0|s
array_nulls|on|
authentication_timeout|60|s
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\t</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Tuples only is off.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\a</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Output format is aligned.
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Расширенный формат:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\x</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Expanded display is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> <span style="color:#323232">*</span> <span style="color:#3b6ac8">from</span> pg_settings <span style="color:#3b6ac8">where</span> name <span style="color:#323232">=</span> <span style="color:#1094a0">'work_mem'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
-[ RECORD 1 ]---+----------------------------------------------------------------------------------------------------------------------
name            | work_mem
setting         | 65536
unit            | kB
category        | Resource Usage / Memory
short_desc      | Sets the maximum memory to be used for query workspaces.
extra_desc      | This much memory can be used by each internal sort operation and hash table before switching to temporary disk files.
context         | user
vartype         | integer
source          | session
min_val         | 64
max_val         | 2097151
enumvals        | 
boot_val        | 4096
reset_val       | 16384
sourcefile      | 
sourceline      | 
pending_restart | f

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Вернем установки по умолчанию.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\x</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Expanded display is off.
</pre></div>
<p class="C">
Все возможности форматирования результатов запросов доступны через команду
\pset.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Взаимодействие с ОС
</h1>
<p class="C">
Можно выполнять команды shell:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\!</span> ls | head <span style="color:#323232">-</span>n <span style="color:#1094a0">10</span>
</pre>
</div>
<div class="R1"><pre class="R1">
dev1_01_tools_overview.sh
dev1_03_arch_mvcc.html
dev1_03_arch_mvcc.sh
dev1_04_arch_wal.html
dev1_04_arch_wal.sh
dev1_05_data_logical.html
dev1_05_data_logical.sh
dev1_06_data_physical.html
dev1_06_data_physical.sh
dev1_07_data_objects.html
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\!</span> pwd
</pre>
</div>
<div class="R1"><pre class="R1">
/home/student/dev1/demo
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Выполнение скриптов
</h1>
<p class="C">
Можно записать вывод команды в файл с помощью \o[ut]:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\o</span> dev1_psql.log
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> name<span style="color:#323232">,</span> setting<span style="color:#323232">,</span> unit <span style="color:#3b6ac8">from</span> pg_settings <span style="color:#3b6ac8">limit</span> <span style="color:#1094a0">5</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<p class="C">
На экран ничего не попало.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Посмотрим в файле:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\!</span> cat dev1_psql.log
</pre>
</div>
<div class="R1"><pre class="R1">
          name           |  setting   | unit 
-------------------------+------------+------
 allow_system_table_mods | off        | 
 application_name        | psql       | 
 archive_command         | (disabled) | 
 archive_mode            | off        | 
 archive_timeout         | 0          | s
(5 rows)

</pre></div>
<p class="C">
Вернем вывод на экран:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\o</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Запишем в файл команды SQL.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\a \t</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Output format is unaligned.
Tuples only is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\pset</span> fieldsep <span style="color:#1094a0">''</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Field separator is "".
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\o</span> dev1_psql.log
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> <span style="color:#1094a0">'select '</span><span style="color:#1094a0">''</span>||tablename||<span style="color:#1094a0">': '</span><span style="color:#1094a0">', count(*) from '</span><span style="color:#323232">,</span>tablename||<span style="color:#1094a0">';'</span> <span style="color:#3b6ac8">from</span> pg_tables <span style="color:#3b6ac8">limit</span> <span style="color:#1094a0">3</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\o</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Вот что получилось в файле:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\!</span> cat dev1_psql.log
</pre>
</div>
<div class="R1"><pre class="R1">
select 'pg_statistic: ', count(*) from pg_statistic;
select 'pg_user_mapping: ', count(*) from pg_user_mapping;
select 'pg_authid: ', count(*) from pg_authid;
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
И выполним теперь эти команды с помощью \i[nclude]:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\i</span> dev1_psql.log
</pre>
</div>
<div class="R1"><pre class="R1">
pg_statistic: 384
pg_user_mapping: 0
pg_authid: 9
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Восстановим форматирование по умолчанию.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\t \a</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Tuples only is off.
Output format is aligned.
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Другие способы выполнить команды из файла:
</p>
<ul class="U">
<li>psql < filename</li>
<li>psql -f filename</li>
<li>psql -c command (работает только для одной команды)</li>
</ul>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Переменные psql
</h1>
<p class="C">
По аналогии с shell, psql имеет собственные переменные.
</p>
<p class="C">
Установим переменную:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\set</span> TEST Hi<span style="color:#323232">!</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Чтобы получить значение, надо предварить имя переменной двоеточием:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\echo :TEST</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Hi!
</pre></div>
<p class="C">
Значение переменной можно сбросить:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\unset</span> TEST
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\echo :TEST</span>
</pre>
</div>
<div class="R1"><pre class="R1">
:TEST
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Переменные можно использовать для хранения текста часто используемых
запросов. Запрос на получение пяти самых больших по размеру таблиц:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\set</span> top5 <span style="color:#1094a0">'SELECT tablename, pg_total_relation_size(schemaname||'</span><span style="color:#1094a0">'.'</span><span style="color:#1094a0">'||tablename) as bytes FROM pg_tables ORDER BY bytes DESC LIMIT 5;'</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Для выполнения запроса достаточно набрать:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">:top5</span>
</pre>
</div>
<div class="R1"><pre class="R1">
   tablename    |  bytes  
----------------+---------
 pg_depend      | 1040384
 pg_proc        |  958464
 pg_rewrite     |  598016
 pg_attribute   |  548864
 pg_description |  483328
(5 rows)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Результат запроса можно записать в переменную с помощью \gset вместо точки
с запятой:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> <span style="color:#c73a69">current_setting</span><span style="color:#323232">(</span><span style="color:#1094a0">'work_mem'</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">as</span> current_work_mem <span style="color:#00a150">\gset</span>
</pre>
</div>
<div class="R1"><pre class="R1">
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\echo</span> Значение work_mem<span style="color:#323232">:</span> <span style="color:#00a150">:current_work_mem</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Значение work_mem: 64MB
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Без параметров \set выдает значения всех переменных, включая встроенные:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\set</span>
</pre>
</div>
<div class="R1"><pre class="R1">
AUTOCOMMIT = 'on'
PROMPT1 = '%/%R%# '
PROMPT2 = '%/%R%# '
PROMPT3 = '>> '
VERBOSITY = 'default'
SHOW_CONTEXT = 'errors'
VERSION = 'PostgreSQL 9.6.1 on i686-pc-linux-gnu, compiled by gcc (Ubuntu 5.3.1-14ubuntu2) 5.3.1 20160413, 32-bit'
HISTFILE = 'hist'
DBNAME = 'tools_overview'
USER = 'student'
HOST = '/var/run/postgresql'
PORT = '5432'
ENCODING = 'UTF8'
LASTOID = '0'
top5 = 'SELECT tablename, pg_total_relation_size(schemaname||'.'||tablename) as bytes FROM pg_tables ORDER BY bytes DESC LIMIT 5;'
current_work_mem = '64MB'
</pre></div>
<p class="C">
Справка по встроенным переменным: \? variables
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Конец демонстрации.
</p>
</body>
</html>

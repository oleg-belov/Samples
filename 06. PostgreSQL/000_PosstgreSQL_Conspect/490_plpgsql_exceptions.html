<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF8">
<style>
p.c    { }
h1     { font-size: 160%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
div.s1 { margin-left: 20px; padding-left: 10px; font-weight: bold; }
div.s2 { margin-left: 80px; padding-left: 10px; font-weight: bold; }
div.s3 { margin-left: 140px; padding-left: 10px; font-weight: bold; }
div.r1 { margin-left: 20px; padding-left: 10px; }
div.r2 { margin-left: 80px; padding-left: 10px; }
div.r3 { margin-left: 140px; padding-left: 10px; }
div.e  { margin-left: 20px; padding-left: 10px; font-weight: bold; <!--color: darkblue;--> }
div.r  { margin-left: 20px; padding-left: 10px; <!--color: darkblue;--> }
</style>
</head>
<body>
<h1>
Имена, коды и категории ошибок
</h1>
<p class="C">
Рассмотрим простой пример:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">t</span><span style="color:#323232">(</span>id <span style="color:#a00050">integer</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    n <span style="color:#a00050">integer</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> id <span style="color:#3b6ac8">INTO STRICT</span> n <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
ERROR:  query returned no rows
CONTEXT:  PL/pgSQL function inline_code_block line 5 at SQL statement
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Чтобы перехватить ошибку, в блоке нужен обработчик:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    n <span style="color:#a00050">integer</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> id <span style="color:#3b6ac8">INTO STRICT</span> n <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">no_data_found</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'Ошибка перехвачена'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  Ошибка перехвачена
DO
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Вместо имени ошибки можно указать ее код, который всегда представляет собой
строку из пяти символов. Определить код ошибки можно с помощью специальной
переменной SQLSTATE (а SQLERRM покажет текст сообщения):
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    n <span style="color:#a00050">integer</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> id <span style="color:#3b6ac8">INTO STRICT</span> n <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">SQLSTATE</span> <span style="color:#1094a0">'P0002'</span> <span style="color:#3b6ac8">THEN</span> <span style="color:#969696">-- no_data_found</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'sqlstate = %, sqlerrm = %'</span><span style="color:#323232">,</span> <span style="color:#a00050">SQLSTATE</span><span style="color:#323232">,</span> <span style="color:#a00050">SQLERRM</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  sqlstate = P0002, sqlerrm = query returned no rows
DO
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Ошибки организованы в своеобразную двухуровневую иерархию. Категория ошибки
имеет код, заканчивающийся на три нуля, и соответствует любой ошибке с теми
же первыми двумя символами.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    n <span style="color:#a00050">integer</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> id <span style="color:#3b6ac8">INTO STRICT</span> n <span style="color:#3b6ac8">FROM</span> t<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> plpgsql_error <span style="color:#3b6ac8">THEN</span> <span style="color:#969696">-- SQLSTATE P0000</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'sqlstate = %, sqlerrm = %'</span><span style="color:#323232">,</span> <span style="color:#a00050">sqlstate</span><span style="color:#323232">,</span> <span style="color:#a00050">sqlerrm</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  sqlstate = P0002, sqlerrm = query returned no rows
DO
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
И в обратную сторону - ошибку можно принудительно вызвать по ее коду или имени:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RAISE</span> <span style="color:#a00050">no_data_found</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">others</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'sqlstate = %, sqlerrm = %'</span><span style="color:#323232">,</span> <span style="color:#a00050">sqlstate</span><span style="color:#323232">,</span> <span style="color:#a00050">sqlerrm</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  sqlstate = P0002, sqlerrm = no_data_found
DO
</pre></div>
<p class="C">
Здесь мы используем специальное имя others, которое соответствует любой
ошибке, которую имеет смысл перехватывать (за исключение прерванного клиентом
выполнения и нарушения отладочной проверки assert).
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
При необходимости можно задействовать и пользовательские коды ошибок,
отсутствующие в справочнике, а также указать некоторую дополнительную
информацию (в примере - только часть из возможного):
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RAISE</span> <span style="color:#a00050">SQLSTATE</span> <span style="color:#1094a0">'ERR01'</span> <span style="color:#3b6ac8">USING</span>
        message <span style="color:#323232">=</span> <span style="color:#1094a0">'Сбой матрицы'</span><span style="color:#323232">,</span>
        detail  <span style="color:#323232">=</span> <span style="color:#1094a0">'При выполнении функции произошел непоправимый сбой матрицы'</span><span style="color:#323232">,</span>
        hint <span style="color:#323232">=</span> <span style="color:#1094a0">'Обратитесь к системному администратору'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
ERROR:  Сбой матрицы
DETAIL:  При выполнении функции произошел непоправимый сбой матрицы
HINT:  Обратитесь к системному администратору
CONTEXT:  PL/pgSQL function inline_code_block line 3 at RAISE
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Эту информацию нельзя получить из переменных; если нужно проанализировать
такие данные в коде, есть специальная конструкция:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">DO</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    message <span style="color:#a00050">text</span><span style="color:#323232">;</span>
    detail <span style="color:#a00050">text</span><span style="color:#323232">;</span>
    hint <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RAISE</span> <span style="color:#a00050">SQLSTATE</span> <span style="color:#1094a0">'ERR01'</span> <span style="color:#3b6ac8">USING</span>
        message <span style="color:#323232">=</span> <span style="color:#1094a0">'Сбой матрицы'</span><span style="color:#323232">,</span>
        detail  <span style="color:#323232">=</span> <span style="color:#1094a0">'При выполнении функции произошел непоправимый сбой матрицы'</span><span style="color:#323232">,</span>
        hint <span style="color:#323232">=</span> <span style="color:#1094a0">'Обратитесь к системному администратору'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">others</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">GET STACKED DIAGNOSTICS</span>
            message <span style="color:#323232">=</span> message_text<span style="color:#323232">,</span>
            detail <span style="color:#323232">=</span> pg_exception_detail<span style="color:#323232">,</span>
            hint <span style="color:#323232">=</span> pg_exception_hint<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> E<span style="color:#1094a0">'\nmessage = %\ndetail = %\nhint = %'</span><span style="color:#323232">,</span> message<span style="color:#323232">,</span> detail<span style="color:#323232">,</span> hint<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  
message = Сбой матрицы
detail = При выполнении функции произошел непоправимый сбой матрицы
hint = Обратитесь к системному администратору
DO
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Стек вызовов
</h1>
<p class="C">
Напишем функции:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">f1</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> n <span style="color:#323232">*</span> <span style="color:#c73a69">f2</span><span style="color:#323232">(</span>n<span style="color:#323232">-</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">f2</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> n <span style="color:#323232">+</span> <span style="color:#c73a69">f3</span><span style="color:#323232">(</span>n<span style="color:#323232">-</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">f3</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">1.0</span> <span style="color:#323232">/</span> n<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Что произойдет при вызове?
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">f1</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>
</pre>
</div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>

<div class="R1"><pre class="R1">
ERROR:  division by zero
CONTEXT:  PL/pgSQL function f3(integer) line 3 at RETURN
PL/pgSQL function f2(integer) line 3 at RETURN
PL/pgSQL function f1(integer) line 3 at RETURN
</pre></div>
<p class="C">
То, что мы видим в сообщении об ошибке - это стек вызовов: сверху вниз =
изнутри наружу.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
В обработчике ошибки можно получить доступ к стеку, правда, в виде одной
строки:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">f3</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    ctx <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">1.0</span> <span style="color:#323232">/</span> n<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">division_by_zero</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">GET STACKED DIAGNOSTICS</span> ctx <span style="color:#323232">=</span> pg_exception_context<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'%'</span><span style="color:#323232">,</span> ctx<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">f1</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  PL/pgSQL function f3(integer) line 5 at RETURN
PL/pgSQL function f2(integer) line 3 at RETURN
PL/pgSQL function f1(integer) line 3 at RETURN
ERROR:  control reached end of function without RETURN
CONTEXT:  PL/pgSQL function f3(integer)
PL/pgSQL function f2(integer) line 3 at RETURN
PL/pgSQL function f1(integer) line 3 at RETURN
</pre></div>
<p class="C">
Что случилось?
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Мы перехватили ошибку, но если теперь функция f3() завершается успешно, она
должна вернуть какое-то значение. Либо нужно вызвать какую-то другую ошибку,
или даже ту же самую (написав просто RAISE).
</p>
<p class="C">
Это случай, когда ошибка происходит внутри обработчика ошибок. Такую ошибку
тоже можно перехватить, но уже не в этом блоке, а во внешнем.
</p>
<p class="C">
Исправимся:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">f3</span><span style="color:#323232">(</span>n <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">float</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    ctx <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">1.0</span> <span style="color:#323232">/</span> n<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">division_by_zero</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">GET STACKED DIAGNOSTICS</span> ctx <span style="color:#323232">=</span> pg_exception_context<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'%'</span><span style="color:#323232">,</span> ctx<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">0.0</span><span style="color:#323232">;</span> <span style="color:#969696">-- добавили</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">f1</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  PL/pgSQL function f3(integer) line 5 at RETURN
PL/pgSQL function f2(integer) line 3 at RETURN
PL/pgSQL function f1(integer) line 3 at RETURN
 f1 
----
  2
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Как не надо: значение или null
</h1>
<p class="C">
Встречаются (и довольно часто) случаи, когда можно обойтись без обработки
ошибок, если выбрать другие подходящие средства. Посмотрим несколько примеров.
</p>
<p class="C">
Задача: вернуть строку из справочника или NULL, если строки нет.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">categories</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">,</span> description <span style="color:#a00050">text</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> categories <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">,</span><span style="color:#1094a0">'Книги'</span><span style="color:#323232">), (</span><span style="color:#1094a0">'discs'</span><span style="color:#323232">,</span><span style="color:#1094a0">'Диски'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 2
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE UNIQUE INDEX ON</span> <span style="color:#c73a69">categories</span><span style="color:#323232">(</span>code<span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE INDEX
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    <span style="color:#3b6ac8">desc</span> <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> c.description <span style="color:#3b6ac8">INTO STRICT desc</span>
    <span style="color:#3b6ac8">FROM</span> categories c
    <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> get_cat_desc.code<span style="color:#323232">;</span>

    <span style="color:#3b6ac8">RETURN desc</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">no_data_found</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RETURN null</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">STABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим, что функция работат правильно:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 get_cat_desc 
--------------
 Книги
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span><span style="color:#1094a0">'movies'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 get_cat_desc 
--------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Можно ли проще? Да, надо просто убрать STRICT или использовать подзапрос:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> <span style="color:#323232">(</span><span style="color:#3b6ac8">SELECT</span> c.description <span style="color:#3b6ac8">FROM</span> categories c <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> get_cat_desc.code<span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">STABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
В таком варианте хорошо видно, что PL/pgSQL тут вообще не нужен - достаточно
SQL.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 get_cat_desc 
--------------
 Книги
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_cat_desc</span><span style="color:#323232">(</span><span style="color:#1094a0">'movies'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 get_cat_desc 
--------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Как не надо: обновить или вставить
</h1>
<p class="C">
Задача: обновить строку таблицы с определенным идентификатором; если такой
строки нет - вставить ее.
</p>
<p class="C">
Первый подход:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">,</span> description <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    cnt <span style="color:#a00050">integer</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">INTO</span> cnt <span style="color:#3b6ac8">FROM</span> categories c <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> change.code<span style="color:#323232">;</span>
    <span style="color:#3b6ac8">IF</span> cnt <span style="color:#323232">=</span> <span style="color:#1094a0">0</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">INSERT INTO</span> categories <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span>code<span style="color:#323232">,</span> description<span style="color:#323232">);</span>
    <span style="color:#3b6ac8">ELSE</span>
        <span style="color:#3b6ac8">UPDATE</span> categories c
        <span style="color:#3b6ac8">SET</span> description <span style="color:#323232">=</span> change.description
        <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> change.code<span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END IF</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
Что здесь плохо?
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Практически все, начиная с того, что такая функция будет работать некорректно
на уровне изоляции read committed при наличии нескольких параллельно
работающих сеансов. Причина в том, что после выполнения SELECT и перед
следующей операцией данные в базе могут измениться.
</p>
<p class="C">
Это легко продемонстрировать, если добавить задержку между командами. Для
разнообразия возьмем немного другой (но тоже неправильный) вариант:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">,</span> description <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">UPDATE</span> categories c
    <span style="color:#3b6ac8">SET</span> description <span style="color:#323232">=</span> change.description
    <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> change.code<span style="color:#323232">;</span>

    <span style="color:#3b6ac8">IF NOT</span> found <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span> <span style="color:#969696">-- тут может произойти все, что угодно</span>
        <span style="color:#3b6ac8">INSERT INTO</span> categories <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span>code<span style="color:#323232">,</span> description<span style="color:#323232">);</span>
    <span style="color:#3b6ac8">END IF</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Теперь выполним функцию в двух сеансах почти одновременно:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span><span style="color:#1094a0">'games'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Игры'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span><span style="color:#1094a0">'games'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Игры'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R2"><pre class="R2">
ERROR:  duplicate key value violates unique constraint "categories_code_idx"
DETAIL:  Key (code)=(games) already exists.
CONTEXT:  SQL statement "INSERT INTO categories VALUES (code, description)"
PL/pgSQL function change(text,text) line 9 at SQL statement

</pre></div>
<div class="R1"><pre class="R1">
 change 
--------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Попробуем решить задачу с помощью обработки ошибки:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">,</span> description <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">LOOP</span>
        <span style="color:#3b6ac8">UPDATE</span> categories c
        <span style="color:#3b6ac8">SET</span> description <span style="color:#323232">=</span> change.description
        <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> change.code<span style="color:#323232">;</span>

        <span style="color:#3b6ac8">EXIT WHEN</span> found<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span> <span style="color:#969696">-- для демонстрации</span>

        <span style="color:#3b6ac8">BEGIN</span>
            <span style="color:#3b6ac8">INSERT INTO</span> categories <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span>code<span style="color:#323232">,</span> description<span style="color:#323232">);</span>
            <span style="color:#3b6ac8">EXIT</span><span style="color:#323232">;</span>
        <span style="color:#3b6ac8">EXCEPTION</span>
            <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">unique_violation</span> <span style="color:#3b6ac8">THEN NULL</span><span style="color:#323232">;</span>
        <span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END LOOP</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим, правильно ли на этот?
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span><span style="color:#1094a0">'vynil'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Грампластинки'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span><span style="color:#1094a0">'vynil'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'Грампластинки'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 change 
--------
 
(1 row)


</pre></div>
<div class="R1"><pre class="R1">
 change 
--------
 
(1 row)

</pre></div>
<p class="C">
Да, правильно.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Но можно проще (начиная с версии 9.5):
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">change</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">,</span> description <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
    <span style="color:#3b6ac8">INSERT INTO</span> categories <span style="color:#3b6ac8">VALUES</span> <span style="color:#323232">(</span>code<span style="color:#323232">,</span> description<span style="color:#323232">)</span>
    <span style="color:#3b6ac8">ON CONFLICT</span><span style="color:#323232">(</span>code<span style="color:#323232">)</span>
        <span style="color:#3b6ac8">DO UPDATE SET</span> description <span style="color:#323232">=</span> change.description<span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE sql</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
Такая команда выполняется атомарно. И снова достаточно простого SQL.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Как не надо: гарантия однопоточности
</h1>
<p class="C">
Задача: гарантировать, что данные обрабатываются одновременно только одним
процессом (на уровне изоляции read committed).
</p>
<p class="C">
Используя ту же таблицу, представим, что периодически категория требует
специальной однопоточной обработки. Можно написать функцию следующим образом:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">PERFORM</span> c.code <span style="color:#3b6ac8">FROM</span> categories c <span style="color:#3b6ac8">WHERE</span> c.code <span style="color:#323232">=</span> process_cat.code
        <span style="color:#3b6ac8">FOR UPDATE NOWAIT</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span> <span style="color:#969696">-- собственно обработка</span>
    <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">'Категория обработана'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> lock_not_available <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">'Другой процесс уже обрабатывает эту категорию'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим, что все правильно:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R2"><pre class="R2">
                  process_cat                  
-----------------------------------------------
 Другой процесс уже обрабатывает эту категорию
(1 row)


</pre></div>
<div class="R1"><pre class="R1">
     process_cat      
----------------------
 Категория обработана
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Но и эту задачу можно решить без обработки ошибок, используя рекомендательные
блокировки:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span>code <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">IF</span> <span style="color:#c73a69">pg_try_advisory_lock</span><span style="color:#323232">(</span><span style="color:#c73a69">hashtext</span><span style="color:#323232">(</span>code<span style="color:#323232">))</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span> <span style="color:#969696">-- собственно обработка</span>
        <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">'Категория обработана'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">ELSE</span>
        <span style="color:#3b6ac8">RETURN</span> <span style="color:#1094a0">'Другой процесс уже обрабатывает эту категорию'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END IF</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">process_cat</span><span style="color:#323232">(</span><span style="color:#1094a0">'books'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R2"><pre class="R2">
                  process_cat                  
-----------------------------------------------
 Другой процесс уже обрабатывает эту категорию
(1 row)


</pre></div>
<div class="R1"><pre class="R1">
     process_cat      
----------------------
 Категория обработана
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Накладные расходы
</h1>
<p class="C">
Почему может захотеться использовать не исключения, а альтернативное решение
(если оно есть)? Дело в накладных расходах, связанных с установкой неявных
точек сохранения и откатом к ним.
</p>
<p class="C">
Задача: преобразовать текстовые данные в числа там, где это возможно.
</p>
<p class="C">
Пусть имеется таблица с текстовым полем, в которое пользователи заносят
произвольные данные (обычно это признак неудачного дизайна, но иногда
приходится). Нам нужно выделить числа в отдельный столбец числового типа.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE data</span><span style="color:#323232">(</span><span style="color:#3b6ac8">comment</span> <span style="color:#a00050">text</span><span style="color:#323232">,</span> n <span style="color:#a00050">numeric</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO data</span><span style="color:#323232">(</span><span style="color:#3b6ac8">comment</span><span style="color:#323232">)</span>
<span style="color:#3b6ac8">SELECT CASE WHEN</span> <span style="color:#c73a69">random</span><span style="color:#323232">() &lt;</span> <span style="color:#1094a0">0.01</span> <span style="color:#3b6ac8">THEN</span> <span style="color:#1094a0">'не число'</span> <span style="color:#969696">--  1%</span>
            <span style="color:#3b6ac8">ELSE</span> <span style="color:#c73a69">random</span><span style="color:#323232">()::</span><span style="color:#a00050">text</span> <span style="color:#3b6ac8">END</span>              <span style="color:#969696">-- 99%</span>
<span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">1000000</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 1000000
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">VACUUM data</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
VACUUM
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Решим задачу с помощью обработки ошибок:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">safe_to_numeric_ex</span><span style="color:#323232">(</span>s <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">numeric</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN</span> s<span style="color:#323232">::</span><span style="color:#a00050">numeric</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> invalid_text_representation <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RETURN null</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">on</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">UPDATE data SET</span> n <span style="color:#323232">=</span> <span style="color:#c73a69">safe_to_numeric_ex</span><span style="color:#323232">(</span><span style="color:#3b6ac8">comment</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
UPDATE 1000000
Time: 7949,883 ms
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">off</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is off.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">FROM data WHERE</span> n <span style="color:#3b6ac8">IS NOT NULL</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 count  
--------
 989860
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
В другом варианте функции вместо обработки ошибки будем проверять формат с
помощью регулярного выражения:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">safe_to_numeric_re</span><span style="color:#323232">(</span>s <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">numeric</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RETURN CASE WHEN</span> s ~ <span style="color:#1094a0">'[0-9.]'</span>
        <span style="color:#3b6ac8">THEN</span> s<span style="color:#323232">::</span><span style="color:#a00050">numeric</span>
        <span style="color:#3b6ac8">ELSE NULL</span>
    <span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span>
$$ <span style="color:#3b6ac8">IMMUTABLE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим такой вариант:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">on</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">UPDATE data SET</span> n <span style="color:#323232">=</span> <span style="color:#c73a69">safe_to_numeric_re</span><span style="color:#323232">(</span><span style="color:#3b6ac8">comment</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
UPDATE 1000000
Time: 4575,293 ms
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">off</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is off.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)</span> <span style="color:#3b6ac8">FROM data WHERE</span> n <span style="color:#3b6ac8">IS NOT NULL</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 count  
--------
 989860
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Получается почти в два раза быстрее. В этом примере исключение срабатывало
всего в 1% случаев. Чем чаще - тем больше будет дополнительных накладных
расходов на откат к точке сохранения.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">UPDATE data SET comment</span> <span style="color:#323232">=</span> <span style="color:#1094a0">'не число'</span><span style="color:#323232">;</span> <span style="color:#969696">-- 100%</span>
</pre>
</div>
<div class="R1"><pre class="R1">
UPDATE 1000000
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">VACUUM data</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
VACUUM
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">on</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is on.
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">UPDATE data SET</span> n <span style="color:#323232">=</span> <span style="color:#c73a69">safe_to_numeric_ex</span><span style="color:#323232">(</span><span style="color:#3b6ac8">comment</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
UPDATE 1000000
Time: 13220,626 ms
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\timing</span> <span style="color:#3b6ac8">off</span>
</pre>
</div>
<div class="R1"><pre class="R1">
Timing is off.
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Это не значит, что обработкой ошибок не нужно пользоваться.
</p>
<p class="C">
Во-первых, язык PL/pgSQL довольно медленный сам по себе из-за интерпретации
и постоянного обращения к SQL для вычисления любого выражения.
</p>
<p class="C">
Во-вторых, очень часто эта скорость вполне удовлетворительна. Да, можно и
быстрее, если написать на C, но зачем?
</p>
<p class="C">
И в-третьих, основные проблемы с производительностью, как правило, связаны
со скоростью выполнения запросов из-за неправильно построенных планов,
а вовсе не со скоростью работы процедурного кода.
</p>
<p class="C">
Но если есть альтернативное решение, которое и проще, и быстрее - конечно
лучше воспользоваться им.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Как надо: обработка пакета документов
</h1>
<p class="C">
Задача: организовать обработку пакета документов; ошибка при обработке одного
документа не должна приводить к общему сбою.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TYPE</span> doc_status <span style="color:#3b6ac8">AS ENUM</span> <span style="color:#323232">(</span><span style="color:#1094a0">'READY'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'ERROR'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'PROCESSED'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TYPE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">documents</span><span style="color:#323232">(</span>
    id <span style="color:#a00050">integer</span><span style="color:#323232">,</span>
    <span style="color:#3b6ac8">version</span> <span style="color:#a00050">integer</span><span style="color:#323232">,</span>
    status doc_status<span style="color:#323232">,</span>
    message <span style="color:#a00050">text</span>
<span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">INSERT INTO</span> <span style="color:#c73a69">documents</span><span style="color:#323232">(</span>id<span style="color:#323232">,</span> <span style="color:#3b6ac8">version</span><span style="color:#323232">,</span> status<span style="color:#323232">)</span>
    <span style="color:#3b6ac8">SELECT</span> g.id<span style="color:#323232">,</span> <span style="color:#1094a0">1</span><span style="color:#323232">,</span> <span style="color:#1094a0">'READY'</span> <span style="color:#3b6ac8">FROM</span> <span style="color:#c73a69">generate_series</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">,</span><span style="color:#1094a0">100</span><span style="color:#323232">)</span> <span style="color:#c73a69">g</span><span style="color:#323232">(</span>id<span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
INSERT 0 100
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Начнем с функции, обрабатывающей все документы. Она вызывает в цикле обработку
одного документа и (для наглядности) возвращает сводную таблицу по итоговым
статусам документов после обработки.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">process_docs</span><span style="color:#323232">()</span>
<span style="color:#3b6ac8">RETURNS TABLE</span><span style="color:#323232">(</span>status doc_status<span style="color:#323232">,</span> <span style="color:#3b6ac8">version</span> <span style="color:#a00050">integer</span><span style="color:#323232">,</span> cnt <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    doc <span style="color:#a00050">record</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">FOR</span> doc <span style="color:#3b6ac8">IN</span> <span style="color:#323232">(</span><span style="color:#3b6ac8">SELECT</span> id <span style="color:#3b6ac8">FROM</span> documents<span style="color:#323232">)</span> <span style="color:#3b6ac8">LOOP</span>
        <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">process_one_doc</span><span style="color:#323232">(</span>doc.id<span style="color:#323232">);</span>
    <span style="color:#3b6ac8">END LOOP</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">RETURN QUERY SELECT</span> d.status<span style="color:#323232">,</span> d.<span style="color:#3b6ac8">version</span><span style="color:#323232">,</span> <span style="color:#c73a69">count</span><span style="color:#323232">(*)::</span><span style="color:#a00050">integer</span>
        <span style="color:#3b6ac8">FROM</span> documents d
        <span style="color:#3b6ac8">GROUP BY</span> d.status<span style="color:#323232">,</span> d.<span style="color:#3b6ac8">version</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Функция, обрабатывающая один документ. Время от времени в ней может возникать
ошибка - в таком случае надо откатить все изменения (это выполняется
автоматически при перехвате ошибки) и поставить ошибочный статус.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">process_one_doc</span><span style="color:#323232">(</span>id <span style="color:#a00050">integer</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span> <span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">UPDATE</span> documents d <span style="color:#969696">----------------------- начало обработки</span>
    <span style="color:#3b6ac8">SET version</span> <span style="color:#323232">=</span> <span style="color:#3b6ac8">version</span> <span style="color:#323232">+</span> <span style="color:#1094a0">1</span>
    <span style="color:#3b6ac8">WHERE</span> d.id <span style="color:#323232">=</span> process_one_doc.id<span style="color:#323232">;</span>

    <span style="color:#3b6ac8">IF</span> <span style="color:#c73a69">random</span><span style="color:#323232">() &lt;</span> <span style="color:#1094a0">0.1</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">RAISE EXCEPTION</span> <span style="color:#1094a0">'Случилось страшное'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END IF</span><span style="color:#323232">;</span> <span style="color:#969696">----------------------------------- конец обработки</span>

    <span style="color:#3b6ac8">UPDATE</span> documents d
    <span style="color:#3b6ac8">SET</span> status <span style="color:#323232">=</span> <span style="color:#1094a0">'PROCESSED'</span>
    <span style="color:#3b6ac8">WHERE</span> d.id <span style="color:#323232">=</span> process_one_doc.id<span style="color:#323232">;</span>
<span style="color:#3b6ac8">EXCEPTION</span>
    <span style="color:#3b6ac8">WHEN</span> <span style="color:#a00050">others</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">UPDATE</span> documents d
        <span style="color:#3b6ac8">SET</span> status <span style="color:#323232">=</span> <span style="color:#1094a0">'ERROR'</span><span style="color:#323232">,</span> message <span style="color:#323232">=</span> <span style="color:#a00050">sqlerrm</span>
        <span style="color:#3b6ac8">WHERE</span> d.id <span style="color:#323232">=</span> process_one_doc.id<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">VOLATILE LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Проверим результат:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">process_docs</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
   process_docs   
------------------
 (PROCESSED,2,90)
 (ERROR,1,10)
(2 rows)

</pre></div>
<p class="C">
Как видно, часть документов не обработалась, но это не помешало остальным.
</p>
<p class="C">
В этом примере обойтись без обработки ошибок не получилось бы: если ошибка
произойдет и не будет обработана - откатится вся транзакция целиком.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Конец демонстрации.
</p>
</body>
</html>

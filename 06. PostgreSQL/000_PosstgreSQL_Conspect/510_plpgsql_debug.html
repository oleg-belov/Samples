<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF8">
<style>
p.c    { }
h1     { font-size: 160%; font-weight: bold; padding-top: 1ex; padding-bottom: 1ex; }
div.s1 { margin-left: 20px; padding-left: 10px; font-weight: bold; }
div.s2 { margin-left: 80px; padding-left: 10px; font-weight: bold; }
div.s3 { margin-left: 140px; padding-left: 10px; font-weight: bold; }
div.r1 { margin-left: 20px; padding-left: 10px; }
div.r2 { margin-left: 80px; padding-left: 10px; }
div.r3 { margin-left: 140px; padding-left: 10px; }
div.e  { margin-left: 20px; padding-left: 10px; font-weight: bold; <!--color: darkblue;--> }
div.r  { margin-left: 20px; padding-left: 10px; <!--color: darkblue;--> }
</style>
</head>
<body>
<h1>
RAISE
</h1>
<p class="C">
Создадим функцию для подсчета количества строк в таблице, имя которой
передается параметром.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">get_count</span> <span style="color:#323232">(</span>tabname <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">bigint</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    cmd <span style="color:#a00050">text</span><span style="color:#323232">;</span>
    retval <span style="color:#a00050">bigint</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    cmd <span style="color:#323232">:=</span> <span style="color:#1094a0">'SELECT COUNT(*) FROM '</span> || <span style="color:#c73a69">quote_ident</span><span style="color:#323232">(</span>tabname<span style="color:#323232">);</span>
    
    <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'cmd: %'</span><span style="color:#323232">,</span> cmd<span style="color:#323232">;</span>

    <span style="color:#3b6ac8">EXECUTE</span> cmd <span style="color:#3b6ac8">INTO</span> retval<span style="color:#323232">;</span>
    <span style="color:#3b6ac8">RETURN</span> retval<span style="color:#323232">;</span> 
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql <span style="color:#3b6ac8">STABLE</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
Для динамического выполнения, текст команды лучше предварительно записывать
в переменную. В случае ошибок, можно получить содержимое переменной.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_count</span><span style="color:#323232">(</span><span style="color:#1094a0">'pg_class'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  cmd: SELECT COUNT(*) FROM pg_class
 get_count 
-----------
       316
(1 row)

</pre></div>
<p class="C">
Строка, начинающаяся с 'NOTICE:', это наша отладочная строка.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
RAISE можно использовать для отслеживания хода выполнения долгого запроса.
</p>
<p class="C">
Предположим, что внутри функции четко выделяются три этапа выполнения И по
ходу работы функции мы хотим понимать, где сейчас находимся.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">long_running_function</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">VOID</span> 
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'long_running_function. Stage 1/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'long_running_function. Stage 2/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'long_running_function. Stage 3/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">RAISE NOTICE</span> <span style="color:#1094a0">'long_running_function. Done.'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Как видим, RAISE выдает сообщения сразу, а не в конце работы функции.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  long_running_function. Stage 1/3...
NOTICE:  long_running_function. Stage 2/3...
NOTICE:  long_running_function. Stage 3/3...
NOTICE:  long_running_function. Done.
 long_running_function 
-----------------------
 
(1 row)

</pre></div>
<p class="C">
Такой подход удобен, когда можно вызвать функцию в отдельном сеансе.
Если же функция вызывается из приложения, то удобнее писать и смотреть в
журнал сервера.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Доработаем функцию msg так, чтобы она выдавала сообщения с уровнем,
установленным в пользовательском параметре app.raise_level:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">raise_msg</span> <span style="color:#323232">(</span>msg <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">CASE</span> <span style="color:#c73a69">current_setting</span><span style="color:#323232">(</span><span style="color:#1094a0">'app.raise_level'</span><span style="color:#323232">)</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'NONE'</span>    <span style="color:#3b6ac8">THEN NULL</span><span style="color:#323232">;</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'NOTICE'</span>  <span style="color:#3b6ac8">THEN RAISE NOTICE</span>  <span style="color:#1094a0">'%,%,%'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">user</span><span style="color:#323232">,</span> <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">(),</span> msg<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'DEBUG'</span>   <span style="color:#3b6ac8">THEN RAISE DEBUG</span>   <span style="color:#1094a0">'%,%,%'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">user</span><span style="color:#323232">,</span> <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">(),</span> msg<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'LOG'</span>     <span style="color:#3b6ac8">THEN RAISE</span> LOG     <span style="color:#1094a0">'%,%,%'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">user</span><span style="color:#323232">,</span> <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">(),</span> msg<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'INFO'</span>    <span style="color:#3b6ac8">THEN RAISE INFO</span>    <span style="color:#1094a0">'%,%,%'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">user</span><span style="color:#323232">,</span> <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">(),</span> msg<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">WHEN</span> <span style="color:#1094a0">'WARNING'</span> <span style="color:#3b6ac8">THEN RAISE WARNING</span> <span style="color:#1094a0">'%,%,%'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">user</span><span style="color:#323232">,</span> <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">(),</span> msg<span style="color:#323232">;</span>
        <span style="color:#3b6ac8">ELSE NULL</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END CASE</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
Предполагается, что параметр app.raise_level всегда установлен.  Для этого
его можно поместить в postgresql.conf.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Для целей примера, ограничимся установкой параметра прямо в сеансе и переделаем
функцию long_running_function на использование raise_msg:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> app.raise_level <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">'NONE'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">long_running_function_2</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">VOID</span> 
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">raise_msg</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 1/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">raise_msg</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 2/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">raise_msg</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 3/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">raise_msg</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Done.'</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Теперь в "обычной" жизни (app.raise_level = NONE) отладочные сообщения не
будут выдаваться:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_2</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 long_running_function_2 
-------------------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Запуская функцию в отдельном сеансе, мы можем получить отладочные сообщения,
выставив app.raise_level в NOTICE:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> app.raise_level <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">'NOTICE'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_2</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  student,2017-07-22 23:40:26.247629+03,long_running_function. Stage 1/3...
NOTICE:  student,2017-07-22 23:40:28.250867+03,long_running_function. Stage 2/3...
NOTICE:  student,2017-07-22 23:40:31.254073+03,long_running_function. Stage 3/3...
NOTICE:  student,2017-07-22 23:40:32.256308+03,long_running_function. Done.
 long_running_function_2 
-------------------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Если же мы хотим включить отладку в приложении с записью в журнал сервера,
то переключаем app.raise_level в LOG:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> app.raise_level <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">'LOG'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_2</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 long_running_function_2 
-------------------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Смотрим в журнал сервера:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">20</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log | <span style="color:#00a150">grep</span> long_running_function
</pre>
</div>
<div class="R"><pre class="R">
2017-07-22 23:40:32 MSK [15037-1] student@plpgsql_debug LOG:  student,2017-07-22 23:40:32.296941+03,long_running_function. Stage 1/3...
	SQL statement "SELECT raise_msg('long_running_function. Stage 1/3...')"
	PL/pgSQL function long_running_function_2() line 3 at PERFORM
2017-07-22 23:40:32 MSK [15037-3] student@plpgsql_debug STATEMENT:  SELECT long_running_function_2();
2017-07-22 23:40:34 MSK [15037-4] student@plpgsql_debug LOG:  student,2017-07-22 23:40:34.299189+03,long_running_function. Stage 2/3...
	SQL statement "SELECT raise_msg('long_running_function. Stage 2/3...')"
	PL/pgSQL function long_running_function_2() line 6 at PERFORM
2017-07-22 23:40:34 MSK [15037-6] student@plpgsql_debug STATEMENT:  SELECT long_running_function_2();
2017-07-22 23:40:37 MSK [15037-7] student@plpgsql_debug LOG:  student,2017-07-22 23:40:37.303445+03,long_running_function. Stage 3/3...
	SQL statement "SELECT raise_msg('long_running_function. Stage 3/3...')"
	PL/pgSQL function long_running_function_2() line 9 at PERFORM
2017-07-22 23:40:37 MSK [15037-9] student@plpgsql_debug STATEMENT:  SELECT long_running_function_2();
2017-07-22 23:40:38 MSK [15037-10] student@plpgsql_debug LOG:  student,2017-07-22 23:40:38.305757+03,long_running_function. Done.
	SQL statement "SELECT raise_msg('long_running_function. Done.')"
	PL/pgSQL function long_running_function_2() line 12 at PERFORM
2017-07-22 23:40:38 MSK [15037-12] student@plpgsql_debug STATEMENT:  SELECT long_running_function_2();
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Управляя параметрами app.raise_level, log_min_messages и client_min_messages,
можно добиться различного поведения отладочных сообщений.
</p>
<p class="C">
Важно, что для этого не нужно менять код приложения.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Межпроцессное взаимодействие (IPC)
</h1>
<p class="C">
Принцип работы. В отладке участвуют два сеанса.  В первом выполняется код,
который отправляет отладочные сообщения.  А второй сеанс получает эти
сообщения.
</p>
<p class="C">
IPC: notify/listen
</p>
<p class="C">
Первый сеанс отправляет сообщения командой NOTIFY, второй сеанс выполняет
команду LISTEN для получения этих сообщений.  Обе команды используют один
и тот же канал dbg.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">long_running_function_3</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">VOID</span> 
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">NOTIFY</span> dbg<span style="color:#323232">,</span> <span style="color:#1094a0">'long_running_function. Stage 1/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">NOTIFY</span> dbg<span style="color:#323232">,</span> <span style="color:#1094a0">'long_running_function. Stage 2/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">NOTIFY</span> dbg<span style="color:#323232">,</span> <span style="color:#1094a0">'long_running_function. Stage 3/3...'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">NOTIFY</span> dbg<span style="color:#323232">,</span> <span style="color:#1094a0">'long_running_function. Done.'</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
В первом сеансе запускаем функцию:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_3</span><span style="color:#323232">();</span>
</pre>
</div>
<p class="C">
Во втором сеансе выполняем LISTEN с паузой в 2 секунды
</p>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LISTEN</span> dbg<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
LISTEN
</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LISTEN</span> dbg<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
LISTEN
</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LISTEN</span> dbg<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
LISTEN
</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LISTEN</span> dbg<span style="color:#323232">;</span>
</pre>
</div>
<div class="R2"><pre class="R2">
LISTEN
Asynchronous notification "dbg" with payload "long_running_function. Stage 1/3..." received from server process with PID 15037.
Asynchronous notification "dbg" with payload "long_running_function. Stage 2/3..." received from server process with PID 15037.
Asynchronous notification "dbg" with payload "long_running_function. Stage 3/3..." received from server process with PID 15037.
Asynchronous notification "dbg" with payload "long_running_function. Done." received from server process with PID 15037.

</pre></div>
<div class="R1"><pre class="R1">
 long_running_function_3 
-------------------------
 
(1 row)

</pre></div>
<p class="C">
Примечание. Команда сервера LISTEN выдает сообщения именно в таком формате.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Команды LISTEN и NOTIFY являются транзакционными.  Отсюда две большие проблемы
для их применения в отладке.
</p>
<p class="C">
Первая в том, что сообщения отправляются только при фиксации транзакции, а
не сразу после выполнения NOTIFY. Поэтому невозможно следить за ходом процесса.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Вторая проблема в том, что если транзакция завершится неуспешно, то сообщения
вообще не будут отправлены.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">BEGIN</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
BEGIN
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_3</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 long_running_function_3 
-------------------------
 
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ROLLBACK</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
ROLLBACK
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LISTEN</span> dbg<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
LISTEN
</pre></div>
<p class="C">
По этим причинам LISTEN и NOTIFY неудобны для отладки.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
IPC: Параметр application_name
</p>
<p class="C">
Первый сеанс меняет значение параметра application_name.  Второй сеанс
периодически опрашивает представление pg_stat_activity.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Новый вариант функции:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">long_running_function_4</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">VOID</span> 
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">SET LOCAL</span> application_name <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">&quot;long_running_function. Stage 1/3...&quot;</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">SET LOCAL</span> application_name <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">&quot;long_running_function. Stage 2/3...&quot;</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">SET LOCAL</span> application_name <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">&quot;long_running_function. Stage 3/3...&quot;</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">SET LOCAL</span> application_name <span style="color:#3b6ac8">TO</span> <span style="color:#1094a0">&quot;long_running_function. Done.&quot;</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql <span style="color:#3b6ac8">VOLATILE</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Запускаем в первом сеансе:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_4</span><span style="color:#323232">();</span>
</pre>
</div>
<p class="C">
Во втором с паузой в 2 секунду обновляем строку из pg_stat_activity:
</p>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">select</span> pid<span style="color:#323232">,</span> usename<span style="color:#323232">,</span> application_name
<span style="color:#3b6ac8">from</span>   pg_stat_activity
<span style="color:#3b6ac8">where</span>  datname <span style="color:#323232">=</span> <span style="color:#1094a0">'plpgsql_debug'</span>
  <span style="color:#3b6ac8">and</span>  pid <span style="color:#323232">&lt;&gt;</span> <span style="color:#c73a69">pg_backend_pid</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 15037 | student | long_running_function. Stage 1/3...

</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\g</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 15037 | student | long_running_function. Stage 2/3...

</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\g</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 15037 | student | long_running_function. Stage 3/3...

</pre></div>
<div class="S2">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#00a150">\g</span>
</pre>
</div>
<div class="R2"><pre class="R2">
 15037 | student | psql


</pre></div>
<div class="R1"><pre class="R1">
 long_running_function_4 
-------------------------
 
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Запись в таблицу: расширение DBLINK
</h1>
<p class="C">
Установим расширение.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE EXTENSION</span> dblink<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE EXTENSION
</pre></div>
<p class="C">
Создаем таблицу для записи сообщений.
</p>
<p class="C">
В таблице полезно сохранять информацию о пользователе и времени вставки.
Столбец id нужен для гарантированной сортировки результата в порядке
добавления строк.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE TABLE</span> <span style="color:#c73a69">log</span> <span style="color:#323232">(</span>
    id       <span style="color:#a00050">serial</span><span style="color:#323232">,</span>
    username <span style="color:#a00050">text</span><span style="color:#323232">,</span>
    ts       <span style="color:#a00050">timestamptz</span><span style="color:#323232">,</span>
    message  <span style="color:#a00050">text</span>
<span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE TABLE
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Теперь создадим функцию для удобного добавления записей в таблицу log.
Функция открывает новый сеанс, выполняет вставку отдельной транзакцией и
закрывает сеанс.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">write_log</span> <span style="color:#323232">(</span>message <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    cmd     <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">dblink_connect</span><span style="color:#323232">(</span><span style="color:#1094a0">'dbname='</span> || <span style="color:#c73a69">current_database</span><span style="color:#323232">());</span>

    cmd <span style="color:#323232">:=</span> <span style="color:#1094a0">'INSERT INTO log (username, ts, message) VALUES ('</span> ||
        <span style="color:#c73a69">quote_literal</span><span style="color:#323232">(</span><span style="color:#3b6ac8">user</span><span style="color:#323232">)</span> || <span style="color:#1094a0">', '</span> ||
        <span style="color:#c73a69">quote_literal</span><span style="color:#323232">(</span><span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">()::</span><span style="color:#a00050">text</span><span style="color:#323232">)</span> || <span style="color:#1094a0">'::timestamp, '</span> ||
        <span style="color:#c73a69">quote_literal</span><span style="color:#323232">(</span>write_log.message<span style="color:#323232">)</span> || <span style="color:#1094a0">')'</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">dblink_exec</span> <span style="color:#323232">(</span>cmd<span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">dblink_disconnect</span><span style="color:#323232">();</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Создаем новый вариант long_running_function.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">long_running_function_5</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_log</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 1/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_log</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 2/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_log</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 3/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_log</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Done.'</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Для проверки запустим long_running_function_5 в отдельной транзакции,
которую в конце откатим. Убедимся, что записи в таблице log остались.
</p>
<p class="C">
Также нужно помнить об очистке таблице log; сделаем это перед запуском.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">TRUNCATE</span> log<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
TRUNCATE TABLE
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">BEGIN</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
BEGIN
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_5</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 long_running_function_5 
-------------------------
 
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ROLLBACK</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
ROLLBACK
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> username<span style="color:#323232">,</span> <span style="color:#c73a69">to_char</span><span style="color:#323232">(</span>ts<span style="color:#323232">,</span> <span style="color:#1094a0">'HH24:MI:SS'</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">as</span> ts<span style="color:#323232">,</span> message
<span style="color:#3b6ac8">FROM</span>   log
<span style="color:#3b6ac8">ORDER BY</span> id<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 username |    ts    |               message               
----------+----------+-------------------------------------
 student  | 23:40:58 | long_running_function. Stage 1/3...
 student  | 23:41:00 | long_running_function. Stage 2/3...
 student  | 23:41:03 | long_running_function. Stage 3/3...
 student  | 23:41:04 | long_running_function. Done.
(4 rows)

</pre></div>
<p class="C">
В таблице сохранились все вызовы write_log, по значениям ts можно проверить,
сколько времени прошло между вызовами.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Запись в файл: pg_file_write()
</h1>
<p class="C">
Установим расширение adminpack.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE EXTENSION</span> adminpack<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE EXTENSION
</pre></div>
<p class="C">
Теперь создадим функцию write_file, которая будет записывать отладочную
информацию в файл. Файл должен располагаться внутри PGDATA, это ограничение
pg_file_write().
</p>
<p class="C">
Если файл журнала должен быть вне PGDATA, то функцию, подобную pg_file_write(),
можно написать на любом недоверенном языке, например plperlU.  В любом
случае функция будет работать с файловой системой с правами пользователя,
запустившего экземпляр СУБД. Как правило это postgres.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">write_file</span> <span style="color:#323232">(</span>message <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    filename CONSTANT <span style="color:#a00050">text</span> <span style="color:#323232">:=</span> <span style="color:#1094a0">'/var/lib/postgresql/9.6/main/pg_log/log.txt'</span><span style="color:#323232">;</span>
    line <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    line <span style="color:#323232">:=</span> <span style="color:#3b6ac8">session_user</span> || <span style="color:#1094a0">','</span> ||
        <span style="color:#c73a69">clock_timestamp</span><span style="color:#323232">()::</span><span style="color:#a00050">text</span> || <span style="color:#1094a0">','</span> ||
        write_file.message ||
        <span style="color:#c73a69">chr</span><span style="color:#323232">(</span><span style="color:#1094a0">10</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_file_write</span><span style="color:#323232">(</span>filename<span style="color:#323232">,</span> line<span style="color:#323232">,</span> <span style="color:#3b6ac8">true</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<p class="C">
Функция записывает отдельной строкой в файл журнала сообщение, переданное
параметром вместе с информацией о том, кто и когда записал строку.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Создадим внешнюю таблицу logfile для чтения файла журнала.
</p>
<p class="C">
Мы не будем рассматривать механизм работы со сторонними данными, это тема
других курсов. Ограничимся коротким примером, показывающим, как связать
csv-файл с таблицей при помощи расширения file_fdw.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE EXTENSION</span> file_fdw<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE EXTENSION
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE SERVER</span> logfile <span style="color:#3b6ac8">FOREIGN DATA WRAPPER</span> file_fdw<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE SERVER
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FOREIGN TABLE</span> <span style="color:#c73a69">logfile</span> <span style="color:#323232">(</span>
    username <span style="color:#a00050">text</span><span style="color:#323232">,</span>
    ts       <span style="color:#a00050">timestamp</span><span style="color:#323232">,</span>
    message  <span style="color:#a00050">text</span>
<span style="color:#323232">)</span> <span style="color:#3b6ac8">SERVER</span> logfile <span style="color:#3b6ac8">OPTIONS</span> <span style="color:#323232">(</span>
    filename <span style="color:#1094a0">'/var/lib/postgresql/9.6/main/pg_log/log.txt'</span><span style="color:#323232">,</span>
    format <span style="color:#1094a0">'csv'</span>
<span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FOREIGN TABLE
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Создаем новый вариант long_running_function.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE FUNCTION</span> <span style="color:#c73a69">long_running_function_6</span> <span style="color:#323232">()</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">void</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_file</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 1/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">2</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_file</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 2/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">3</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_file</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Stage 3/3...'</span><span style="color:#323232">);</span>
    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">pg_sleep</span><span style="color:#323232">(</span><span style="color:#1094a0">1</span><span style="color:#323232">);</span>

    <span style="color:#3b6ac8">PERFORM</span> <span style="color:#c73a69">write_file</span><span style="color:#323232">(</span><span style="color:#1094a0">'long_running_function. Done.'</span><span style="color:#323232">);</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Для проверки запустим long_running_function_6 в отдельной транзакции,
которую в конце откатим.
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">BEGIN</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
BEGIN
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">long_running_function_6</span><span style="color:#323232">();</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 long_running_function_6 
-------------------------
 
(1 row)

</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">ROLLBACK</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
ROLLBACK
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> username<span style="color:#323232">,</span> <span style="color:#c73a69">to_char</span><span style="color:#323232">(</span>ts<span style="color:#323232">,</span> <span style="color:#1094a0">'HH24:MI:SS'</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">as</span> ts<span style="color:#323232">,</span> message
<span style="color:#3b6ac8">FROM</span>   logfile
<span style="color:#3b6ac8">ORDER BY</span> ts<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 username |    ts    |               message               
----------+----------+-------------------------------------
 student  | 23:41:05 | long_running_function. Stage 1/3...
 student  | 23:41:07 | long_running_function. Stage 2/3...
 student  | 23:41:10 | long_running_function. Stage 3/3...
 student  | 23:41:11 | long_running_function. Done.
(4 rows)

</pre></div>
<p class="C">
Как видим, записи в журнале появились.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Трассировка сессий
</h1>
<p class="C">
Для простоты считаем, что трассировка включается установкой
log_statement='all'.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Сделаем простую функцию для включения/отключения трассировки:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">CREATE OR REPLACE FUNCTION</span> <span style="color:#c73a69">trace</span> <span style="color:#323232">(</span><span style="color:#3b6ac8">mode</span> <span style="color:#a00050">text</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">RETURNS</span> <span style="color:#a00050">text</span>
<span style="color:#3b6ac8">AS</span> $$
<span style="color:#3b6ac8">DECLARE</span>
    retval <span style="color:#a00050">text</span><span style="color:#323232">;</span>
<span style="color:#3b6ac8">BEGIN</span>
    <span style="color:#3b6ac8">IF mode</span> <span style="color:#323232">=</span> <span style="color:#1094a0">'ON'</span> <span style="color:#3b6ac8">THEN</span> 
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">set_config</span><span style="color:#323232">(</span><span style="color:#1094a0">'log_statement'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'all'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">false</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">INTO</span> retval<span style="color:#323232">;</span>
    <span style="color:#3b6ac8">ELSIF mode</span> <span style="color:#323232">=</span> <span style="color:#1094a0">'OFF'</span> <span style="color:#3b6ac8">THEN</span>
        <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">set_config</span><span style="color:#323232">(</span><span style="color:#1094a0">'log_statement'</span><span style="color:#323232">,</span> <span style="color:#1094a0">'none'</span><span style="color:#323232">,</span> <span style="color:#3b6ac8">false</span><span style="color:#323232">)</span> <span style="color:#3b6ac8">INTO</span> retval<span style="color:#323232">;</span>
    <span style="color:#3b6ac8">END IF</span><span style="color:#323232">;</span>
    <span style="color:#3b6ac8">RETURN</span> retval<span style="color:#323232">;</span>
<span style="color:#3b6ac8">END</span><span style="color:#323232">;</span>
$$ <span style="color:#3b6ac8">LANGUAGE</span> plpgsql<span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
CREATE FUNCTION
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Теперь мы можем включить трассировку:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">trace</span><span style="color:#323232">(</span><span style="color:#1094a0">'ON'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 trace 
-------
 all
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
...выполнить команды:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_count</span><span style="color:#323232">(</span><span style="color:#1094a0">'pg_views'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  cmd: SELECT COUNT(*) FROM pg_views
 get_count 
-----------
       115
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
... и выключить трассировку:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">trace</span><span style="color:#323232">(</span><span style="color:#1094a0">'OFF'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
 trace 
-------
 none
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Информация о выполненных командах окажется в журнале сервера:
</p>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">10</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log | <span style="color:#00a150">grep</span> get_count
</pre>
</div>
<div class="R"><pre class="R">
2017-07-22 23:41:11 MSK [15037-13] student@plpgsql_debug LOG:  statement: SELECT get_count('pg_views');
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Запись в журнал планов запросов: auto_explain
</h1>
<p class="C">
Загрузим расширение в память текущего процесса:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">LOAD</span> <span style="color:#1094a0">'auto_explain'</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
LOAD
</pre></div>
<p class="C">
Установим отслеживание всех команд:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> auto_explain.log_min_duration <span style="color:#323232">=</span> <span style="color:#1094a0">0</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Выполним функцию get_count, в журнал сервера попадет команда и план выполнения:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_count</span><span style="color:#323232">(</span><span style="color:#1094a0">'pg_tables'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  cmd: SELECT COUNT(*) FROM pg_tables
 get_count 
-----------
        63
(1 row)

</pre></div>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">3</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log
</pre>
</div>
<div class="R"><pre class="R">
2017-07-22 23:41:11 MSK [15037-15] student@plpgsql_debug LOG:  duration: 1.611 ms  plan:
	Query Text: SELECT get_count('pg_tables');
	Result  (cost=0.00..0.26 rows=1 width=8)
</pre></div>
<p class="C">
Но вложенный в функцию SELECT не попал в журнал.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Включим отслеживание вложенных команд и повторим запрос:
</p>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SET</span> auto_explain.log_nested_statements <span style="color:#323232">=</span> <span style="color:#3b6ac8">on</span><span style="color:#323232">;</span>
</pre>
</div>
<div class="R1"><pre class="R1">
SET
</pre></div>
<div class="S1">
<pre style="color:#323232; background-color:#ffffff;  "><span style="color:#323232">=&gt;</span> <span style="color:#3b6ac8">SELECT</span> <span style="color:#c73a69">get_count</span><span style="color:#323232">(</span><span style="color:#1094a0">'pg_proc'</span><span style="color:#323232">);</span>
</pre>
</div>
<div class="R1"><pre class="R1">
NOTICE:  cmd: SELECT COUNT(*) FROM pg_proc
 get_count 
-----------
      2885
(1 row)

</pre></div>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<div class="E">
<pre style="color:#323232; background-color:#ffffff;  ">$ <span style="color:#00a150">tail</span> <span style="color:#323232">-</span>n <span style="color:#1094a0">9</span> <span style="color:#323232">/</span>var<span style="color:#323232">/</span>log<span style="color:#323232">/</span>postgresql<span style="color:#323232">/</span>postgresql-9.6<span style="color:#323232">-</span>main.log
</pre>
</div>
<div class="R"><pre class="R">
2017-07-22 23:41:11 MSK [15037-16] student@plpgsql_debug LOG:  duration: 0.512 ms  plan:
	Query Text: SELECT COUNT(*) FROM pg_proc
	Aggregate  (cost=94.37..94.38 rows=1 width=8)
	  ->  Index Only Scan using pg_proc_oid_index on pg_proc  (cost=0.28..87.21 rows=2862 width=0)
2017-07-22 23:41:11 MSK [15037-17] student@plpgsql_debug CONTEXT:  SQL statement "SELECT COUNT(*) FROM pg_proc"
	PL/pgSQL function get_count(text) line 10 at EXECUTE
2017-07-22 23:41:11 MSK [15037-18] student@plpgsql_debug LOG:  duration: 0.701 ms  plan:
	Query Text: SELECT get_count('pg_proc');
	Result  (cost=0.00..0.26 rows=1 width=8)
</pre></div>
<p class="C">
Теперь в журнале не только вызов функции, но и вложенный запрос.  Вместе с
планами выполнения.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<h1>
Замечание по безопасности
</h1>
<p class="C">
Функции write_log и trace используют возможности, которые требуют прав
суперпользователя. Как сделать так, чтобы эти функции были доступны обычным
пользователям, рассматривается в теме, посвященной разграничению доступа.
</p>
<hr size=0 style="border-top: 1px dashed grey; border-bottom: 0;"/>
<p class="C">
Конец демонстрации.
</p>
</body>
</html>
